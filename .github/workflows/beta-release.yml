name: Release to Beta
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+-beta*'
      - 'v[0-9]+.[0-9]+.[0-9]+-alpha*'

jobs:
  beta-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      # ====== è¯­æ³•æ£€æŸ¥é˜¶æ®µ ======
      - name: Bash syntax validation
        run: |
          echo "ğŸ” æ‰§è¡Œ Bash è¯­æ³•æ£€æŸ¥..."
          if bash -n PVE-Tools.sh; then
            echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ è¯­æ³•æ£€æŸ¥å¤±è´¥ï¼Œç»ˆæ­¢å‘å¸ƒæµç¨‹"
            exit 1
          fi

      - name: ShellCheck analysis
        run: |
          echo "ğŸ” æ‰§è¡Œ ShellCheck é™æ€åˆ†æ..."
          shellcheck -e SC2086,SC2181,SC2162 -f gcc PVE-Tools.sh || true

          # Beta ç‰ˆæœ¬å…è®¸æ›´å®½æ¾çš„æ£€æŸ¥
          if shellcheck -S error PVE-Tools.sh; then
            echo "âœ… ShellCheck æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸  ShellCheck å‘ç°é—®é¢˜ï¼Œä½†ç»§ç»­å‘å¸ƒ Beta ç‰ˆæœ¬"
          fi

      # ====== ç‰ˆæœ¬ç®¡ç†é˜¶æ®µ ======
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ å‘å¸ƒ Beta ç‰ˆæœ¬: $VERSION"

      - name: Update VERSION file
        run: |
          echo "${{ steps.get_version.outputs.VERSION }}" > VERSION

      - name: Update script version
        run: |
          sed -i "s/CURRENT_VERSION=\".*\"/CURRENT_VERSION=\"${{ steps.get_version.outputs.VERSION }}\"/" PVE-Tools.sh

      - name: Commit version changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add VERSION PVE-Tools.sh
          git commit -m "chore: update beta version to ${{ steps.get_version.outputs.VERSION }}" || echo "No changes to commit"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: beta

      # ====== ç”Ÿæˆæ›´æ–°æ—¥å¿—é˜¶æ®µ ======
      - name: Generate formatted changelog
        id: changelog
        run: |
          echo "ğŸ“ ç”Ÿæˆ Beta ç‰ˆæœ¬æ›´æ–°æ—¥å¿—..."

          # è·å–æ ‡ç­¾ä¿¡æ¯
          CURRENT_TAG=$(git describe --tags --abbrev=0)
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          # å¦‚æœæ²¡æœ‰å‰ä¸€ä¸ªæ ‡ç­¾ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæäº¤
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "ğŸ“Š ç‰ˆæœ¬èŒƒå›´: $PREVIOUS_TAG â†’ $CURRENT_TAG"

          # ç”Ÿæˆåˆ†ç±»çš„æ›´æ–°æ—¥å¿—
          cat > changelog.md << 'CHANGELOG_EOF'
          ## ğŸ“‹ Beta ç‰ˆæœ¬æ›´æ–°æ—¥å¿—

          CHANGELOG_EOF

          # æ–°å¢åŠŸèƒ½
          FEATURES=$(git log --pretty=format:"%s (%an)" $PREVIOUS_TAG..$CURRENT_TAG | grep -i "^feat\|^feature" || true)
          if [ -n "$FEATURES" ]; then
            echo "### âœ¨ æ–°å¢åŠŸèƒ½" >> changelog.md
            echo "$FEATURES" | sed 's/^feat\(([^)]*)\)\?://i' | sed 's/^feature\(([^)]*)\)\?://i' | while read line; do
              echo "- $line" >> changelog.md
            done
            echo "" >> changelog.md
          fi

          # é”™è¯¯ä¿®å¤
          FIXES=$(git log --pretty=format:"%s (%an)" $PREVIOUS_TAG..$CURRENT_TAG | grep -i "^fix\|^bugfix" || true)
          if [ -n "$FIXES" ]; then
            echo "### ğŸ› é”™è¯¯ä¿®å¤" >> changelog.md
            echo "$FIXES" | sed 's/^fix\(([^)]*)\)\?://i' | sed 's/^bugfix\(([^)]*)\)\?://i' | while read line; do
              echo "- $line" >> changelog.md
            done
            echo "" >> changelog.md
          fi

          # å®éªŒæ€§åŠŸèƒ½
          EXPERIMENTAL=$(git log --pretty=format:"%s (%an)" $PREVIOUS_TAG..$CURRENT_TAG | grep -i "^experimental\|^wip" || true)
          if [ -n "$EXPERIMENTAL" ]; then
            echo "### ğŸ§ª å®éªŒæ€§åŠŸèƒ½" >> changelog.md
            echo "$EXPERIMENTAL" | sed 's/^experimental\(([^)]*)\)\?://i' | sed 's/^wip\(([^)]*)\)\?://i' | while read line; do
              echo "- $line" >> changelog.md
            done
            echo "" >> changelog.md
          fi

          # å…¶ä»–æ”¹åŠ¨
          OTHERS=$(git log --pretty=format:"%s (%an)" $PREVIOUS_TAG..$CURRENT_TAG | grep -iv "^feat\|^feature\|^fix\|^bugfix\|^experimental\|^wip\|^chore\|^style\|^refactor\|^test\|^build\|^ci" || true)
          if [ -n "$OTHERS" ]; then
            echo "### ğŸ”§ å…¶ä»–æ”¹åŠ¨" >> changelog.md
            echo "$OTHERS" | while read line; do
              echo "- $line" >> changelog.md
            done
            echo "" >> changelog.md
          fi

          # æäº¤ç»Ÿè®¡
          COMMIT_COUNT=$(git rev-list --count $PREVIOUS_TAG..$CURRENT_TAG)
          echo "### ğŸ“Š ç‰ˆæœ¬ç»Ÿè®¡" >> changelog.md
          echo "- æäº¤æ•°é‡: $COMMIT_COUNT" >> changelog.md

          # è¯»å–ç”Ÿæˆçš„ changelog
          CHANGELOG_CONTENT=$(cat changelog.md)

          # ä½¿ç”¨ EOF åˆ†éš”ç¬¦è¾“å‡ºå¤šè¡Œå†…å®¹
          echo "CHANGELOG<<CHANGELOG_DELIMITER" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "CHANGELOG_DELIMITER" >> $GITHUB_OUTPUT

          echo "âœ… Beta ç‰ˆæœ¬æ›´æ–°æ—¥å¿—ç”Ÿæˆå®Œæˆ"

      # ====== åˆ›å»º Beta Release ======
      - name: Create GitHub Beta Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: ğŸš§ Beta Release v${{ steps.get_version.outputs.VERSION }}
          body: |
            # PVE Tools 9 - Beta v${{ steps.get_version.outputs.VERSION }}

            > âš ï¸  **è¿™æ˜¯æµ‹è¯•ç‰ˆæœ¬**
            > æ­¤ç‰ˆæœ¬ç”¨äºåŠŸèƒ½æµ‹è¯•å’Œæ—©æœŸä½“éªŒï¼Œå¯èƒ½å­˜åœ¨æœªçŸ¥é—®é¢˜ã€‚
            > **è¯·å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼**

            ${{ steps.changelog.outputs.CHANGELOG }}

            ---

            ## ğŸ“¥ å®‰è£…æ–¹å¼

            ### Beta ç‰ˆæœ¬å®‰è£…
            ```bash
            bash <(curl -sSL https://raw.githubusercontent.com/Mapleawaa/PVE-Tools-9/beta/PVE-Tools.sh)
            ```

            ### æ‰‹åŠ¨ä¸‹è½½
            ```bash
            wget https://github.com/Mapleawaa/PVE-Tools-9/releases/download/v${{ steps.get_version.outputs.VERSION }}/PVE-Tools.sh
            chmod +x PVE-Tools.sh
            sudo ./PVE-Tools.sh
            ```

            ## âš ï¸  ä½¿ç”¨é¡»çŸ¥
            1. å»ºè®®åœ¨è™šæ‹Ÿæœºæˆ–æµ‹è¯•ç¯å¢ƒä¸­ä½¿ç”¨
            2. ä½¿ç”¨å‰è¯·å¤‡ä»½é‡è¦æ•°æ®
            3. å‘ç°é—®é¢˜è¯·åŠæ—¶åé¦ˆ

            ## ğŸ’¬ åé¦ˆæ¸ é“
            - [æäº¤ Bug](https://github.com/Mapleawaa/PVE-Tools-9/issues/new?template=report-bugs.md)
            - [åŠŸèƒ½å»ºè®®](https://github.com/Mapleawaa/PVE-Tools-9/issues/new?template=feature-request.md)

            ---

            **å®Œæ•´æäº¤å†å²**: [`${{ steps.get_version.outputs.VERSION }}`](https://github.com/Mapleawaa/PVE-Tools-9/commits/v${{ steps.get_version.outputs.VERSION }})
          draft: false
          prerelease: true
          files: |
            PVE-Tools.sh
            VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
