name: Syntax Check on Push

on:
  push:
    branches:
      - main
      - beta
    paths:
      - '*.sh'
      - 'Tools/*.sh'

jobs:
  syntax-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Bash syntax check
        run: |
          echo "ğŸ” æ£€æŸ¥ Bash è„šæœ¬è¯­æ³•..."
          if bash -n PVE-Tools.sh; then
            echo "âœ… PVE-Tools.sh è¯­æ³•æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ PVE-Tools.sh è¯­æ³•æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

          # æ£€æŸ¥ Tools ç›®å½•ä¸‹çš„è„šæœ¬
          for script in Tools/*.sh; do
            if [ -f "$script" ]; then
              echo "ğŸ” æ£€æŸ¥ $script..."
              if bash -n "$script"; then
                echo "âœ… $script è¯­æ³•æ£€æŸ¥é€šè¿‡"
              else
                echo "âŒ $script è¯­æ³•æ£€æŸ¥å¤±è´¥"
                exit 1
              fi
            fi
          done

      - name: ShellCheck lint
        run: |
          echo "ğŸ” æ‰§è¡Œ ShellCheck é™æ€åˆ†æ..."
          # å¿½ç•¥ä¸€äº›å¸¸è§çš„è­¦å‘Šï¼ˆæ ¹æ®é¡¹ç›®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
          shellcheck -e SC2086,SC2181,SC2162 -f gcc PVE-Tools.sh || true

          # ä¸¥æ ¼æ¨¡å¼ï¼šæ£€æŸ¥ä¸¥é‡é”™è¯¯
          if shellcheck -S error PVE-Tools.sh; then
            echo "âœ… ShellCheck ä¸¥é‡é”™è¯¯æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ ShellCheck å‘ç°ä¸¥é‡é”™è¯¯"
            exit 1
          fi

      - name: Check for dangerous commands
        run: |
          echo "ğŸ” æ£€æŸ¥æ½œåœ¨å±é™©å‘½ä»¤..."
          DANGEROUS_PATTERNS=("rm -rf /" "dd if=" "mkfs." ":(){ :|:& };:")

          for pattern in "${DANGEROUS_PATTERNS[@]}"; do
            if grep -q "$pattern" PVE-Tools.sh; then
              echo "âš ï¸  å‘ç°æ½œåœ¨å±é™©å‘½ä»¤: $pattern"
            fi
          done

          echo "âœ… å±é™©å‘½ä»¤æ£€æŸ¥å®Œæˆ"

      - name: Report results
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ æ‰€æœ‰è¯­æ³•æ£€æŸ¥é€šè¿‡ï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
