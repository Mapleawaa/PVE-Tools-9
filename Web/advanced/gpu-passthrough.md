# Intel 核显直通深度教程：告别代码 43

在 PVE 虚拟化环境当中，把 Intel 核显也就是 iGPU 直通给 Windows 虚拟机，一直都被折腾玩家视作“噩梦”以及“高频翻车点”。其常见的症状囊括了：设备管理器里会显示“代码 43”、虚拟机出现黑屏、又或者是安装驱动之后马上蓝屏乃至异常重启。

本文会基于维护者的视角，来解析 **PVE-Tools** 如何凭借自动化手段去处理这些问题，同时还整理了清晰的排障路径：在尽量不涉及“玄学”的前提之下，让你知晓**脚本修改了什么、如何进行验证、哪里容易出问题、以及出了问题要怎么退回去**。

## 技术原理

传统的核显直通也就是 Legacy Passthrough 在 PVE 9.0+ 的高版本内核当中兼容性比较差，并且在新内核以及新 QEMU 的组合之下，兼容性波动比较大。PVE-Tools 所选用的核心方案是：**黑名单驱动 + 修改版 QEMU + ROM 注入**。

具体的步骤如下：

1.  **屏蔽宿主机占用**：借助在 `/etc/modprobe.d/` 当中添加黑名单的方式，来防止宿主机内核加载 `i915` 驱动去占用核显。针对新平台，还需要避免新引入的 `xe` 驱动把设备提前绑定，从而导致 VM 初始化链路不完整。
2.  **虚拟化层兼容处理**：选用社区维护的修改版 `pve-qemu-kvm`，修复了部分内核地址映射的问题，并且可能会基于平台来调整 VM 参数，比如 `q35/OVMF`、`PCIe` 标志、`rombar` 等，以此提升 Windows 侧的识别与初始化成功率。
3.  **ROM 注入**：把特定版本的核显 VBIOS 也就是 ROM 注入到虚拟机配置当中，让 Windows 能够正确地识别硬件初始化信息。

> 直通本质上是在“欺骗”虚拟机，它其实更像是“把一段硬件初始化流程搬进 VM 当中”。鉴于 Intel 每代核显存在微架构差异，任何一环的缺失都可能会表现为 Code 43、黑屏或者驱动异常。

## 适用范围与前提

*   **CPU/核显代际**：Intel 6 代也就是 Skylake 至 14 代也就是 Raptor Lake Refresh。常见的 CPU 囊括了：N5105, N100, i5-12400, i7-13700 等。
*   **客体系统**：Windows 10/11，其对初始化链路更为敏感。
*   **必须满足**：
    1.  BIOS 开启了 **VT-d / IOMMU** 以及 **Internal Graphics**。
    2.  直通设备需要拥有可用并且独立的 **IOMMU Group**，不然就属于硬件或者主板拓扑方面的问题，需要参考 [Proxmox 官方文档](pve.proxmox.com) 来进行调整。
*   **不做承诺**：在不同主板固件、核显步进以及内核版本的组合之下，直通成功率会存在波动。失败并不等同于“脚本错误”。本文所提供的乃是**可复现的排障路径以及回滚方案**，并非“百分百成功”的承诺。

> **风险提示**：直通会让这个设备在宿主机上变得不可用。**建议在更新内核或者执行直通脚本之前，先给 PVE 宿主机去做好快照或者备份工作。**

## 动手前自检，即确认“底座成立”

在对系统任何配置进行修改之前，请先在 PVE 宿主机终端里执行以下命令，来确认基础环境契合直通的要求。

```bash
# 1) 确认虚拟化与 IOMMU 开启情况（Intel 常见关键词：DMAR）
dmesg | grep -E "DMAR|IOMMU|Interrupt Remapping" -n

# 2) 确认 VFIO 相关模块是否加载（未加载会导致直通失败或表现异常）
lsmod | grep -E "vfio|kvm" -n

# 3) 找到核显设备与当前绑定驱动（00:02.0 常见，但以实际为准）
lspci -nnk | grep -A3 -E "VGA|Display"

# 4) 查看 IOMMU Group（设备至少需要能被单独/可控地隔离）
find /sys/kernel/iommu_groups/ -type l
```

## 操作流程

### 第一步：准备工作
确保你的 BIOS 当中已经开启了 **VT-d** 以及 **Internal Graphics**。**务必确保在修改之前准备好可用的控制台访问，像 IPMI、iKVM 或者本地显示器**，以防配置失误导致没法通过 SSH 来连接宿主机。

### 第二步：执行脚本
进入 `直通与显卡` -> `Intel 核显直通配置`也就是`修改版 QEMU`，去选择“开始配置”。

### 第三步：虚拟机设置
脚本执行完成之后，你需要去虚拟机的 `.conf` 文件当中确认以下的配置：
```conf
args: -device 'vfio-pci,host=00:02.0,addr=0x18,guest-reset=0,romfile=intel.bin'
```
> [!TIP]
> 脚本会自动帮你去完成绝大部分文件的下载以及配置映射。关于 ROM 注入、直通参数、q35/OVMF 的兼容性建议，可以参考 [Proxmox 官方 Wiki](pve.proxmox.com) 当中的解释以及例子。

## 常见坑点与警示

- **Jasper Lake 也就是 N5105/N6005**：这一代核显非常特殊，要是遇到直通后黑屏的情况，主要原因囊括 ROM 版本不匹配，建议尝试不同的 ROM 文件。
- **内核冲突**：在 PVE 9.1+ 当中，新引入的 `xe` 驱动可能会去抢占设备。脚本会自动尝试去屏蔽它。
- **救砖提示**：如果配置之后导致所有虚拟机没法启动或者宿主机异常，请选用脚本当中的“救砖模式”来进行官方 QEMU 环境的一键恢复。

## 排障速查表

| 现象 | 可能原因 | 优先检查 | 处理建议 |
| :--- | :--- | :--- | :--- |
| Windows 设备管理器 **代码 43** | 初始化信息不完整、ROM或者设备暴露方式不匹配、宿主机驱动进行了抢占 | VM 配置是否有 `romfile`或者直通参数；宿主机是否仍加载 iGPU 驱动 | 按照本文流程来确保宿主机驱动不抢占；确认 ROM 注入路径以及格式；必要时更换 ROM 版本，特别是 Jasper Lake |
| VM 黑屏 / NoVNC 黑屏 | GPU 被当作主显输出策略、显示设备冲突 | VM 是否同时启用了虚拟显卡；是否正确设置了 OVMF/q35 | 直通 GPU 时建议选用 q35/OVMF，并且调整显示策略，必要时禁用虚拟显示 |
| 直通后宿主机也丢显示或者异常 | 把宿主机正在使用的 iGPU 给“抢走”了 | 宿主机是否依赖 iGPU 进行输出 | **生产环境强烈建议运用独显做宿主输出**；或者确保宿主机无需图形输出 |
| 升级内核后突然失效 | 内核或者驱动链路发生变化，比如新驱动介入 | `lspci -nnk` 所显示的绑定驱动是否变化 | 锁定内核版本或者按照本文的回滚以及再配置流程去处理 |

## 回滚说明

如果直通失败或者希望恢复到初始状态，请遵循以下的原则来进行回滚：

1.  **恢复宿主机驱动加载**：撤销（或者注释掉）在 `/etc/modprobe.d/` 当中所添加的黑名单又或者是参数。
2.  **恢复官方虚拟化组件**：要是脚本替换过 `qemu` 组件，请选用脚本的“救砖模式”或者手动进行官方 `pve-qemu-kvm` 包的恢复。
3.  **清理 VM 配置**：移除虚拟机 `.conf` 文件当中的直通参数，比如 `args:` 行，以及 `romfile` 的引用，来确保 VM 能用纯虚拟显卡启动。

**回滚后自检**：
- 执行 `lspci -nnk | grep -A3 -E “VGA|Display“` 来确认 iGPU 已经重新绑定到了宿主机驱动，像 `i915` 或者 `xe`。
- 执行 `dmesg | grep -E “i915|xe“ -n` 来查看驱动的初始化是否正常。

## 结语
鉴于 Intel 每代核显的微架构差异以及软硬件环境的复杂性，直通过程充满了变数。如果失败了，欢迎在项目 Issue 当中提交你的 **CPU 型号、PVE 版本、完整的虚拟机配置以及脚本运行或者系统日志**，这会帮助社区共同去排查问题。要记住，可以回滚的折腾才是安全的折腾。