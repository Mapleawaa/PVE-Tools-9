# Intel 核显直通深度教程：告别代码 43

在 PVE 环境下，将 Intel 核显 (iGPU) 直通给 Windows 虚拟机一直是折腾玩家的“噩梦”。常见的症状包括：设备管理器显示“代码 43”、虚拟机黑屏、或者安装驱动后直接蓝屏。

本教程将解析 PVE-Tools 如何通过自动化手段解决这些问题。

## 技术原理

传统的核显直通（Legacy Passthrough）在 PVE 9.0+ 的高版本内核中兼容性较差。PVE-Tools 采用的方案主要包含以下核心步骤：

1. **屏蔽宿主机驱动**：通过在 `/etc/modprobe.d/` 中添加黑名单，防止宿主机内核加载 `i915` 驱动占用核显。
2. **修改版 QEMU**：使用社区大佬维护的修改版 `pve-qemu-kvm`，修复了部分内核地址映射问题。
3. **ROM 注入**：将特定版本的核显 VBIOS (ROM) 注入到虚拟机配置中，让 Windows 能够正确识别硬件初始化信息。

## 适用范围

- **支持架构**：Intel 6代 (Skylake) 至 14代 (Raptor Lake Refresh)。
- **常见 CPU**：N5105, N100, i5-12400, i7-13700 等。

## 操作流程

### 第一步：准备工作
确保你的 BIOS 中已开启 **VT-d** 和 **Internal Graphics**。

### 第二步：执行脚本
进入 `直通与显卡` -> `Intel 核显直通配置 (修改版 QEMU)`，选择“开始配置”。

### 第三步：虚拟机设置
脚本执行完成后，你需要在虚拟机的 `.conf` 文件中确认以下配置：
```conf
args: -device 'vfio-pci,host=00:02.0,addr=0x18,guest-reset=0,romfile=intel.bin'
```
> [!TIP]
> 脚本会自动帮你完成大部分文件的下载和配置映射。

## 常见坑点与警示

- **Jasper Lake (N5105/N6005)**：这一代核显非常特殊，如果遇到直通后黑屏，通常是 ROM 版本不匹配，建议尝试不同的 ROM 文件。
- **内核冲突**：在 PVE 9.1+ 中，新引入的 `xe` 驱动可能会抢占设备。脚本会自动尝试屏蔽它。
- **救砖提示**：如果配置后导致所有虚拟机无法启动，请使用脚本中的“救砖模式”一键恢复官方 QEMU 环境。

## 结语
直通本质上是在“骗”虚拟机。由于 Intel 每代核显的微架构差异，没有任何一种方案能保证 100% 成功。如果失败了，欢迎在项目 Issue 中提交你的 CPU 型号和报错日志。
