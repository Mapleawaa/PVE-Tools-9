# 核显虚拟化：SR-IOV 与 GVT-g 的抉择

如果你希望一个核显能同时带动多个虚拟机（比如一个给 OpenWrt 做硬解，一个给 Windows 做日常使用），那么核显虚拟化就是你的最佳选择。

## 两种技术的区别

### 1. GVT-g (第 6 代至第 10 代 Intel)
这是 Intel 较早推出的中介透传技术。
- **优点**：成熟稳定，支持 2D/3D 加速。
- **缺点**：最高只支持到 10 代 CPU，资源分配相对固定。

### 2. SR-IOV (第 11 代及以后)
Intel 在新一代 CPU 上全面转向 SR-IOV 方案。
- **优点**：性能损耗极低，最多支持切分出 7 个虚拟功能 (VF)。
- **缺点**：配置相对复杂，需要安装特定的 DKMS 驱动。

## PVE-Tools 的实现逻辑

### 对于 11代+ (SR-IOV)
脚本会执行以下操作：
1. 安装 `i915-sriov-dkms` 驱动。
2. 修改 GRUB 引导参数，开启 `i915.enable_guc=3` 和 `i915.max_vfs=7`。
3. 自动配置 `sysfs` 规则，确保开机自动生成虚拟核显。

### 对于 6-10代 (GVT-g)
脚本会执行以下操作：
1. 开启 IOMMU 和内核模块 `kvmgt`, `vfio-mdev`。
2. 引导你手动在 PVE 网页端的“硬件” -> “添加” -> “PCI 设备”中选择 MDEV 类型。

## 避坑指南

> [!WARNING]
> **内核升级风险**：SR-IOV 极其依赖内核头文件。如果你升级了 PVE 内核，必须重新运行脚本或重新编译 DKMS 驱动，否则虚拟核显会全部消失！

- **显示输出**：虚拟出的核显通常没有物理接口输出，只能通过远程桌面 (RDP) 或 Parsec 等工具使用。
- **显存分配**：请确保宿主机内存充足，因为虚拟核显会占用一部分系统内存作为显存。

## 验证命令
配置完成后，可以使用以下命令检查是否成功：
```bash
# 查看虚拟设备
lspci | grep VGA
# 检查驱动状态
dmesg | grep i915
```

核显虚拟化让 PVE 的可玩性翻了倍，快去尝试把你的 iGPU 榨干吧！
