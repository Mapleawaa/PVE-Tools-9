# 核显虚拟化：SR-IOV 与 GVT-g 的抉择

如果你希望能让一个核显同时去驱动多个虚拟机，像给 OpenWrt 做硬解或者给 Windows 做日常使用，那么核显虚拟化便是你的最佳选用。这是一条更具“工程化”色彩的路线：性能更稳定、资源分配更可控，也更利于开展长期的维护工作。

本文会以维护者视角来整理两条路线：**GVT-g 也就是老平台** 以及 **SR-IOV 也就是新平台**，并且补齐自检、排障与回滚的方案。

## 两种技术的区别

### 1. GVT-g (第 6 代至第 10 代 Intel)
这是 Intel 较早推出的中介透传技术。
- **优点**：成熟且稳定，支持 2D/3D 加速，资料多、踩坑也已被社区反复验证。
- **缺点**：最高仅能支持到 10 代 CPU，资源分配相对比较固定。

### 2. SR-IOV (第 11 代及以后)
Intel 在新一代 CPU 上全面转向了 SR-IOV 方案。
- **优点**：性能损耗极低，最多支持去切分出 7 个虚拟功能也就是 VF。
- **缺点**：配置相对复杂，需要去安装特定的 DKMS 驱动；对内核或者驱动版本高度敏感，属于“可用但需要去维护”的方案。

> [!WARNING]
> **维护边界**：SR-IOV 的“稳定”源自于内核版本、headers、DKMS 驱动、kernel cmdline 参数、VF 自动生成机制这几项长期保持一致。请把它当作“需要去维护的驱动栈”而非“一次配置便永久稳定”来看待。

## 适用范围

- **GVT-g**：面向较旧代际平台，即 6–10 代。
- **SR-IOV**：面向较新代际平台，即 11+。
- **使用形态**：核显虚拟化通常不会给你提供物理输出，也就是没有物理接口，常见的用法是借助 RDP、Parsec 或者远程桌面来进行使用，这属于正常现象。

## PVE-Tools 的实现逻辑

### 对于 11代+ 也就是 SR-IOV
脚本会去执行以下的操作：
1. 安装 `i915-sriov-dkms` 驱动。
2. 对 GRUB 引导参数进行修改，开启 `i915.enable_guc=3` 以及 `i915.max_vfs=7`。
3. 自动配置 `sysfs` 规则，来确保开机自动生成虚拟核显。

### 对于 6-10代 也就是 GVT-g
脚本会去执行以下的操作：
1. 开启 IOMMU 以及内核模块 `kvmgt`, `vfio-mdev`。
2. 引导你手动在 PVE 网页端的“硬件” -> “添加” -> “PCI 设备”当中去选择 MDEV 类型。

## 深度自检命令

配置完成之后，可以使用以下的命令来检查是否得以实现：

### 基础检查
```bash
# 查看设备与绑定驱动
lspci -nnk | grep -A3 -E "VGA|Display"

# 检查驱动日志（i915/xe）
dmesg | grep -E "i915|xe" -n | tail -n 120
```

### SR-IOV 专用检查（确认 PF / VF 状态）
> 把 `0000:00:02.0` 替换为你实际的核显 BDF。

```bash
# PF 是否暴露了 SR-IOV 能力
ls -la /sys/bus/pci/devices/0000:00:02.0/ | grep sriov
cat /sys/bus/pci/devices/0000:00:02.0/sriov_totalvfs 2>/dev/null
cat /sys/bus/pci/devices/0000:00:02.0/sriov_numvfs 2>/dev/null

# 是否生成了 VF（通常会多出若干个 Display controller）
lspci | grep -E "VGA|Display"
```

## 避坑指南与排障

> [!WARNING]
> **内核升级风险**：SR-IOV 极其依赖内核头文件。如果你升级了 PVE 内核，必须重新去运行脚本或者重新编译 DKMS 驱动，否则虚拟核显会全部消失！

- **显示输出**：虚拟出来的核显通常没有物理接口输出，只能借助远程桌面也就是 RDP 或者 Parsec 等工具来进行使用。
- **显存分配**：请确保宿主机内存充足，因为虚拟核显会去占用一部分系统内存来当作显存。

### 常见翻车点速查表

| 现象 | 常见原因 | 优先检查 | 建议处理 |
| ----------------------- | ------------------------------ | --------------------------------------- | --------------------------------------- |
| 内核升级后 **VF 全消失** | DKMS 未重编译 / headers 不匹配 / 参数丢失 | `dkms status`、`uname -r`、是否存在对应 headers | 先让 DKMS 与目标内核契合；必要时回退到已验证可用的内核版本 |
| `sriov_numvfs` 设置后卡死或者异常 | 驱动或者固件组合问题；参数不完整 | `dmesg` 是否出现 hang；cmdline 参数是否正确 | 降低 VF 数量；校正关键参数；先跑通再追求“切满 7 个” |
| VF 已生成但 Guest 内不可用 | Guest 驱动不匹配/未安装/被错误驱动绑定 | Guest 内 `lspci -nnk` | 先确认传的是 VF 而非 PF；再按 Guest OS 安装或者匹配驱动 |
| PF 被直通后导致全局崩溃 | 把 PF 直接丢进 VM，从而牵连所有 VF | VM 配置里的 hostpci 指向 | 原则：**只给 VM 传 VF，不要去传 PF**（尤其在 VF 已生成的系统当中） |

## 回滚方案

如果配置后系统不稳定或者希望恢复单核显模式，请按照以下的步骤进行回滚。

### SR-IOV 回滚（恢复为“宿主机单核显”）
1. 停止 VF 的生成：把 `sriov_numvfs` 设回 `0`
2. 移除或者回退 kernel cmdline 当中与 SR-IOV 相关的参数（比如 `i915.max_vfs`、`xe.max_vfs`、驱动黑名单切换项）
3. 若选用了 DKMS 驱动包：按其卸载方式去移除，并且重建 initramfs，重启验证

### GVT-g 回滚
1. 移除 VM 当中的 mdev 配置
2. 停用相关的模块加载项
3. 重启后确认宿主机 iGPU 工作正常

## 参考资料（权威/原始出处）

- i915 SR-IOV DKMS 项目说明（内核范围、参数、i915/xe 切换、VF 生成方式）：[https://github.com/strongtz/i915-sriov-dkms](https://github.com/strongtz/i915-sriov-dkms)

---

核显虚拟化让 PVE 的可玩性翻了倍，快去尝试把你的 iGPU 给榨干吧！